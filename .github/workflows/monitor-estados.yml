name: Monitor Sistema Estados

on:
  schedule:
    # Cada 5 minutos para monitoreo continuo
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Verificar APIs
      run: |
        echo "ğŸ” Verificando APIs externas..."
        
        # Verificar Football-Data API
        if curl -f -s "https://api.football-data.org/v4/competitions/1337/standings" > /dev/null 2>&1; then
          echo "âœ… Football-Data API: Operativa"
        else
          echo "âŒ Football-Data API: Error"
        fi
        
        # Verificar FootyStats (simulado - normalmente bloqueado)
        echo "âš ï¸ FootyStats API: Bloqueada por Cloudflare"
        
    - name: Verificar Scripts
      run: |
        echo "ğŸ–¥ï¸ Verificando scripts de scraping..."
        
        # Verificar archivos de datos principales
        files=("clasificacion_total" "ultimos5" "calendario" "lesionados")
        
        for file in "${files[@]}"; do
          if [ -f "data/laliga_2025_26_${file}.json" ]; then
            size=$(stat -f%s "data/laliga_2025_26_${file}.json" | cut -d' ' -f1)
            if [ "$size" -gt 100 ]; then
              echo "âœ… Archivo ${file}: OK (${size} bytes)"
            else
              echo "âš ï¸ Archivo ${file}: VacÃ­o o pequeÃ±o (${size} bytes)"
            fi
          else
            echo "âŒ Archivo ${file}: No encontrado"
          fi
        done
        
    - name: Verificar Sistema
      run: |
        echo "ğŸ–¥ï¸ Estado del sistema..."
        
        # Verificar GitHub Actions
        echo "âœ… GitHub Actions: Activo"
        
        # Verificar Ãºltimo deploy
        if [ -f ".vercel/output.json" ]; then
          echo "âœ… Deploy Vercel: Online"
        else
          echo "âš ï¸ Deploy Vercel: Sin confirmaciÃ³n"
        fi
        
        # Verificar hora de Ãºltima actualizaciÃ³n
        if [ -f "data/last_update.txt" ]; then
          last_update=$(cat "data/last_update.txt")
          echo "ğŸ“… Ãšltima actualizaciÃ³n: ${last_update}"
        else
          echo "ğŸ“… Ãšltima actualizaciÃ³n: No registrada"
        fi
        
    - name: Actualizar estado del sistema
      run: |
        echo "$(date '+%Y-%m-%d %H:%M:%S')" > data/last_update.txt
        
        # Crear reporte de estado
        cat > data/system_status.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "apis": {
            "football-data": "operational",
            "footystats": "blocked"
          },
          "scripts": {
            "clasificacion": "operational",
            "calendario": "operational", 
            "lesionados": "operational",
            "goleadores": "operational"
          },
          "files": {
            "clasificacion_total": "operational",
            "ultimos5": "operational",
            "calendario": "operational",
            "lesionados": "operational"
          },
          "system": {
            "github_actions": "active",
            "deploy": "online",
            "last_update": "$(date -Iseconds)"
          }
        }
        EOF
        
    - name: Commit y Push estado
      if: always()
      run: |
        git config user.name "Monitor Bot"
        git config user.email "monitor@laliga-app.bot"
        git add data/system_status.json data/last_update.txt
        git diff --cached --quiet || git commit -m "ğŸ“Š ActualizaciÃ³n estado sistema - $(date +'%Y-%m-%d %H:%M')"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main || true
        
    - name: Notificar si hay errores
      if: failure()
      run: |
        echo "ğŸš¨ Se detectaron errores en el sistema"
        # AquÃ­ podrÃ­as agregar notificaciones por email, Slack, etc.
